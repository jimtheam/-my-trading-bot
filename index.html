<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡é‡åŒ–ç»ˆç«¯ (è¯Šæ–­æ¨¡å¼)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 20px; }
        h1 { font-size: 1.5rem; color: #38bdf8; text-align: center; margin-bottom: 10px; }
        
        /* çŠ¶æ€æ  */
        .status-bar { text-align: center; margin-bottom: 20px; font-size: 0.9rem; color: #94a3b8; background: #1e293b; padding: 10px; border-radius: 8px;}
        .blink { animation: blinker 1.5s linear infinite; color: #22c55e; font-weight: bold;}
        @keyframes blinker { 50% { opacity: 0; } }

        /* å¡ç‰‡å®¹å™¨ */
        .card-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        
        /* å•ä¸ªè‚¡ç¥¨å¡ç‰‡ */
        .stock-card {
            background: #1e293b; border-radius: 8px; padding: 15px; width: 170px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #334155;
            transition: all 0.2s; position: relative;
        }
        .stock-card:hover { transform: translateY(-5px); border-color: #64748b; }

        .symbol { font-size: 1.3rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .timestamp { font-size: 0.7rem; color: #64748b; font-weight: normal;}
        
        .price { font-size: 1.4rem; margin: 10px 0; color: #fff; font-family: monospace; }
        
        .indicators { font-size: 0.75rem; color: #94a3b8; margin-bottom: 10px; line-height: 1.4; background: #0f172a; padding: 5px; border-radius: 4px;}
        
        .signal-box { 
            text-align: center; padding: 8px; border-radius: 4px; font-weight: bold; font-size: 0.9rem;
        }

        /* ä¿¡å·é¢œè‰² */
        .buy { background: #064e3b; color: #34d399; border: 1px solid #059669; box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .sell { background: #450a0a; color: #f87171; border: 1px solid #dc2626; box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
        .neutral { background: #334155; color: #94a3b8; }

        /* é”™è¯¯æç¤ºåŒºåŸŸ */
        .message-box { 
            text-align: center; margin-top: 50px; font-size: 1.1rem; padding: 20px; 
            border: 2px dashed #475569; border-radius: 10px; width: 80%; margin-left: auto; margin-right: auto;
        }
    </style>
</head>
<body>

    <h1>ğŸš€ é‡åŒ–è‡ªåŠ¨äº¤æ˜“ç»ˆç«¯ <span style="font-size:0.8rem; background:#f59e0b; color:black; padding:2px 6px; border-radius:4px;">è¯Šæ–­ç‰ˆ</span></h1>
    
    <div class="status-bar">
        ç³»ç»ŸçŠ¶æ€: <span id="sys-status" class="blink">â— æ­£åœ¨è¿æ¥...</span> | 
        æœ€ååˆ·æ–°: <span id="last-update">-</span>
    </div>

    <div id="container" class="card-container">
        <!-- è¿™é‡Œçš„æ–‡å­—ä¼šè¢«è„šæœ¬æ›¿æ¢ -->
        <div class="message-box" id="msg-area" style="color: #38bdf8;">
            ğŸ“¡ æ­£åœ¨å°è¯•è¿æ¥æœ¬åœ°åå° (http://127.0.0.1:8000)...<br>
            <span style="font-size:0.9rem; color:#94a3b8">è¯·ç¡®ä¿é»‘è‰²çª—å£ (CMD) æ­£åœ¨è¿è¡Œ</span>
        </div>
    </div>

    <script>
        // 1. å®šä¹‰ API åœ°å€
        // å¦‚æœä½ æ˜¯é€šè¿‡ http://127.0.0.1:8000 è®¿é—®çš„ï¼Œè¿™é‡Œç•™ç©ºå³å¯è‡ªåŠ¨è¯†åˆ«
        // å¦‚æœä½ æ˜¯åŒå‡»æ‰“å¼€æ–‡ä»¶çš„ï¼Œè¿™é‡Œå¿…é¡»å†™æ­» http://127.0.0.1:8000
        const API_URL = ""; 

        async function updateData() {
            const msgArea = document.getElementById("msg-area");
            const statusSpan = document.getElementById("sys-status");
            const container = document.getElementById("container");

            try {
                // 2. å‘èµ·è¯·æ±‚
                const response = await fetch(`${API_URL}/results`);
                
                // 3. æ£€æŸ¥ç½‘ç»œçŠ¶æ€
                if (!response.ok) {
                    throw new Error(`åå°æŠ¥é”™: ${response.status} ${response.statusText}`);
                }

                // 4. è§£ææ•°æ®
                const json = await response.json();
                const data = json.data;

                // 5. æˆåŠŸè¿æ¥ï¼Œæ›´æ–°çŠ¶æ€
                statusSpan.innerText = "â— è”æœºæ­£å¸¸";
                statusSpan.style.color = "#22c55e"; // ç»¿è‰²

                // 6. æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
                if (!data || data.length === 0) {
                    if (container.innerHTML.includes("stock-card")) return; // å¦‚æœå·²ç»æœ‰å¡ç‰‡äº†å°±ä¸æ¸…ç©º
                    
                    container.innerHTML = `
                        <div class="message-box" style="color: orange;">
                            âœ… è¿æ¥æˆåŠŸï¼Œä½†æš‚æ— æ•°æ®ã€‚<br><br>
                            åå°æ­£åœ¨è®¡ç®—ç¬¬ä¸€è½®æ•°æ® (éœ€è¦30-60ç§’)...<br>
                            è¯·è§‚å¯Ÿé»‘è‰²çª—å£æ˜¯å¦æ˜¾ç¤º "æ›´æ–°å®Œæˆ"ã€‚
                        </div>`;
                    return;
                }

                // 7. æœ‰æ•°æ®äº†ï¼Œå¼€å§‹æ¸²æŸ“
                renderCards(data);
                
                // æ›´æ–°æ—¶é—´
                document.getElementById("last-update").innerText = new Date().toLocaleTimeString();

            } catch (error) {
                console.error("è¿æ¥å¤±è´¥:", error);
                
                // 8. æ˜¾ç¤ºè¯¦ç»†é”™è¯¯åŸå› 
                statusSpan.innerText = "â— è¿æ¥æ–­å¼€";
                statusSpan.style.color = "#ef4444"; // çº¢è‰²
                
                // åªæœ‰åœ¨æ²¡æœ‰å¡ç‰‡æ˜¾ç¤ºçš„æ—¶å€™æ‰æ˜¾ç¤ºå¤§å¤§çš„é”™è¯¯æ¡†ï¼Œé¿å…é—ªçƒ
                if (!container.innerHTML.includes("stock-card")) {
                    container.innerHTML = `
                        <div class="message-box" style="color: #ef4444; border-color: #ef4444;">
                            âŒ <strong>æ— æ³•è·å–æ•°æ®</strong><br><br>
                            é”™è¯¯è¯¦æƒ…: ${error.message}<br><br>
                            <strong>è¯·æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š</strong><br>
                            1. é»‘è‰²çª—å£ (start.bat) æ˜¯å¦æ„å¤–å…³é—­äº†ï¼Ÿ<br>
                            2. é»‘è‰²çª—å£é‡Œæ˜¯å¦æœ‰çº¢è‰²çš„ Error æŠ¥é”™ï¼Ÿ<br>
                            3. ä½ æ˜¯å¦ä½¿ç”¨äº†å…¨å±€ä»£ç† (VPN)ï¼Ÿ
                        </div>
                    `;
                }
            }
        }

        function renderCards(data) {
            const container = document.getElementById("container");
            
            // ä¸ºäº†é˜²æ­¢åˆ·æ–°æ—¶é¡µé¢é—ªçƒï¼Œæˆ‘ä»¬é‡‡ç”¨â€œå·®å¼‚æ›´æ–°â€æˆ–ç®€å•å…¨é‡æ›´æ–°
            // è¿™é‡Œç®€å•æ¸…ç©ºé‡ç»˜
            container.innerHTML = ""; 

            // æ’åºï¼šæœ‰ä¿¡å·çš„æ’åœ¨æœ€å‰é¢
            data.sort((a, b) => {
                const scoreA = a.signal !== "NEUTRAL" ? 10 : 0;
                const scoreB = b.signal !== "NEUTRAL" ? 10 : 0;
                return scoreB - scoreA;
            });

            data.forEach(item => {
                const card = document.createElement("div");
                card.className = "stock-card";
                
                let signalClass = "neutral";
                let signalText = "è§‚æœ› (WAIT)";
                
                if (item.signal === "BUY") { 
                    signalClass = "buy"; 
                    signalText = "ğŸŸ¢ åšå¤š (CALL)"; 
                    card.style.borderColor = "#34d399"; // ç»¿è¾¹æ¡†
                }
                if (item.signal === "SELL") { 
                    signalClass = "sell"; 
                    signalText = "ğŸ”´ åšç©º (PUT)"; 
                    card.style.borderColor = "#f87171"; // çº¢è¾¹æ¡†
                }

                card.innerHTML = `
                    <div class="symbol">
                        ${item.symbol} 
                        <span class="timestamp">${item.timestamp}</span>
                    </div>
                    <div class="price">$${item.price.toFixed(2)}</div>
                    <div class="indicators">
                        RSI: ${item.rsi.toFixed(1)} <br>
                        EMA: ${item.ema.toFixed(1)} <br>
                        MACD: ${item.macd_val.toFixed(3)}
                    </div>
                    <div class="signal-box ${signalClass}">
                        ${signalText}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ç«‹å³è¿è¡Œä¸€æ¬¡
        updateData();
        // æ¯ 3 ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(updateData, 3000);
    </script>
</body>
</html>